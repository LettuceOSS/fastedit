name: Continuous Integration

on:
  pull_request:
    branches:
      - 'main'

env:
  FFMPEG_BIN_DIR: /usr/local/bin

jobs:
  Build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Install FFmpeg
      run: sudo apt update && sudo apt install ffmpeg -y
    - name: Verify FFmpeg installation
      run: ffmpeg -version
    - name: Changing permissions on FFmpeg
      run: sudo chmod +x /usr/bin/ffmpeg
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg
        path: /usr/bin/ffmpeg
  Test:
    needs: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ffmpeg
      - name: Changing permissions on FFmpeg
        run: sudo chmod +x ./ffmpeg
      - name: Make FFmpeg executable available in PATH
        run: sudo mv ./ffmpeg $FFMPEG_BIN_DIR/ffmpeg
      - name: Verify FFmpeg installation
        run: ffmpeg -version
      - name: Upgrade pip
        run: pip install --upgrade pip
      - name: Install test dependencies
        run: pip install -e .[test]
      - name: Perform test
        run: pytest
  Quality:
    needs: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          path: $FFMPEG_BIN
      - name: Upgrade pip
        run: pip install --upgrade pip
      - name: Install lint dependencies
        run: pip install -e .[lint]
      - name: Perform lint
        run: flake8